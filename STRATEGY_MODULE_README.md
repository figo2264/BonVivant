# Hanlyang Stock - Strategy Module (전략 실행 모듈)

## 📋 개요

`strategy.py`는 한량 주식 프로젝트의 핵심 실행 모듈로, **하이브리드 전략(기술적 분석 + 뉴스 감정 분석)**을 기반으로 자동화된 주식 매매를 수행합니다. 이 모듈은 cron 작업으로 실행되도록 설계되어 있으며, 매일 정해진 시간에 매도/매수 전략을 자동으로 실행합니다.

## 🏗️ 아키텍처

### 모듈 구성
```
strategy.py (메인 실행 파일)
├── hanlyang_stock/
│   ├── config/          # 설정 관리
│   ├── strategy/        # 전략 실행
│   │   ├── executor.py  # 매수/매도 실행자
│   │   └── selector.py  # 종목 선택기
│   ├── analysis/        # 분석 모듈
│   │   ├── technical.py # 기술적 분석
│   │   └── news_sentiment.py # 뉴스 감정 분석
│   ├── data/           # 데이터 처리
│   └── utils/          # 유틸리티
```

### 실행 시간
- **매도 전략**: 오전 8시 30분 ~ 8시 32분 (2분간)
- **매수 전략**: 오후 3시 20분 ~ 3시 22분 (2분간)

## 🚀 주요 기능

### 1. 하이브리드 전략 (Hybrid Strategy)
기술적 분석과 뉴스 감정 분석을 결합한 혁신적인 투자 전략

#### 가중치 구성
- **기술적 분석**: 50% (0.5)
- **뉴스 감정 분석**: 50% (0.5)
- **최소 종합 점수**: 60% (0.6)

#### 종합 점수 계산
```python
combined_score = (technical_score * 0.5) + (news_score * 0.5)
```

### 2. 손실 제한 (Stop Loss)
- **기본 손실 제한**: -5%
- 손실률이 설정값을 초과하면 즉시 매도
- 다른 매도 조건보다 우선순위가 높음

### 3. 고급 홀드 시그널 (Advanced Hold Signal)
- **RSI 홀드 범위**: 30-70
- **거래량 급증 기준**: 2.0배
- 3일차에 종합적인 홀드 판단 수행

### 4. 안정성 중심 타겟 설정
- **수익 기준**: 0.5% 이상
- **변동성 제어**: 활성화
- **급락 방지**: 활성화

## 📊 뉴스 기반 전략 상세 설명

### 뉴스 수집 및 분석 프로세스

#### 1. 뉴스 수집 (News Collection)
- **데이터 소스**: 네이버 증권
- **수집 방법**: Selenium을 이용한 동적 크롤링
- **필터링**: 경제 전문지 위주 (한국경제, 연합인포맥스 등)
- **수집량**: 종목당 최대 10개 뉴스

#### 2. 감정 분석 (Sentiment Analysis)
- **AI 모델**: Claude 3.5 Sonnet API
- **분석 항목**:
  - 뉴스 긍정/부정/중립 분류
  - 시간별 주가 상승 확률 예측 (1일, 5일, 10일, 20일)
  - 종합 감정 평가

#### 3. 예측 확률 활용
```python
# 시간별 예측 확률
- 1일 후 상승 확률: XX%
- 5일 후 상승 확률: XX%  # 주요 활용 지표
- 10일 후 상승 확률: XX%
- 20일 후 상승 확률: XX%
```

### 뉴스 기반 매수 결정 프로세스

1. **기술적 분석 통과 종목 선별**
   - RSI, 이동평균선, 볼린저 밴드 등 기술적 지표 분석
   - AI 모델을 통한 추가 스코어링

2. **뉴스 감정 분석 추가**
   - 각 종목의 최근 뉴스 수집
   - Claude API를 통한 감정 분석 및 예측

3. **종합 점수 계산 및 최종 선정**
   ```python
   if combined_score >= 0.60:  # 60% 이상
       매수 대상 선정
   ```

### 뉴스 기반 매도 신호

보유 기간에 따른 예측값 활용:
- **1일 보유**: 1일 후 예측 → 5일 후 예측 확인
- **2-3일 보유**: 5일 예측 → 10일 예측 확인
- **4일 이상**: 10일 예측 확인

매도 조건:
- 현재 시점 예측이 45% 미만 (하락 예상)
- 예측 추세가 10%p 이상 급격한 하락

## 🔧 기술적 지표 상세 설명

### 1. RSI (Relative Strength Index)
- **계산 기간**: 14일
- **과매도 구간**: 30 미만
- **과매수 구간**: 70 초과
- **활용**: 과매도 시 매수 신호, 과매수 시 매도 신호

### 2. 이동평균선 (Moving Average)
- **단기**: 5일, 10일
- **중기**: 20일
- **활용**: 현재가와 이동평균선의 괴리율 분석

### 3. 볼린저 밴드 (Bollinger Bands)
- **중심선**: 20일 이동평균
- **표준편차**: 2배
- **활용**: 하단 근처에서 매수, 상단 근처에서 매도

### 4. 거래량 분석
- **기준 기간**: 5일 평균
- **급증 기준**: 2배 이상
- **활용**: 거래량 급증 시 추세 전환 신호

### 5. 변동성 지표
- **계산 기간**: 10일
- **고변동성 기준**: 5% 초과
- **활용**: 고변동성 종목 회피

## 💰 투자 금액 결정 로직

### 종합 점수 기반 차등 투자
```python
if score >= 0.80:       # 최고신뢰
    investment = 800,000원
elif score >= 0.70:     # 고신뢰
    investment = 600,000원
elif score >= 0.65:     # 중신뢰
    investment = 400,000원
else:                   # 저신뢰
    investment = 300,000원
```

### 추가 조정 사항
- 뉴스 감정이 부정적인 경우: 투자금액 30% 감소
- 최대 보유 종목: 10개
- 안전 자금: 200만원 (항상 유지)

## 📈 성과 추적 및 로깅

### 매도 시 기록 정보
- 매도 종목 및 수량
- 보유 기간
- 수익률 및 손익
- 매도 사유 (손실제한, 보유기간, 뉴스신호 등)

### 매수 시 기록 정보
- 매수 종목 및 수량
- 투자 금액
- AI 점수 및 신뢰도
- 하이브리드 점수 상세 (기술적/뉴스)

## 🔍 디버깅 및 모니터링

### 뉴스 디버깅 모드
```python
'debug_news': True  # 뉴스 분석 과정 상세 출력
```

### 슬랙 알림
- 매도/매수 체결 알림
- 일일 요약 보고서
- 오류 발생 시 즉시 알림

## 🛡️ 리스크 관리

### 1. 데이터 검증
- 종목 데이터 유효성 검사
- 가격 범위 확인 (1,000원 ~ 500,000원)
- 거래량 확인 (거래정지 종목 제외)

### 2. 포트폴리오 관리
- 최대 보유 종목 수: 10개
- 종목당 최대 투자: 80만원
- 현금 비중: 최소 20% + 안전자금 200만원

### 3. 매매 시간 관리
- 매도: 장 시작 직후 (유동성 확보)
- 매수: 장 마감 전 (당일 가격 동향 반영)

## 🚦 실행 방법

### 직접 실행
```bash
python strategy.py
```

### Cron 설정 예시
```bash
# 매일 오전 8시 30분 실행
30 8 * * * /path/to/python /path/to/strategy.py >> /path/to/cron_am.log 2>&1

# 매일 오후 3시 20분 실행
20 15 * * * /path/to/python /path/to/strategy.py >> /path/to/cron_pm.log 2>&1
```

## ⚙️ 설정 변경

주요 설정은 코드 내에서 직접 수정 가능:

```python
# 하이브리드 전략 가중치
strategy_data['news_weight'] = 0.5      # 뉴스 가중치
strategy_data['technical_weight'] = 0.5  # 기술적 가중치

# 손실 제한
strategy_data['stop_loss_rate'] = -0.05  # -5%

# 최대 선정 종목
strategy_data['max_selections'] = 3
```

## 📝 주의사항

1. **API 키 설정**: `.env` 파일에 필수 API 키 설정 필요
   - `ANTHROPIC_API_KEY`: Claude API 키
   - 기타 증권사 API 키

2. **시장 상황 고려**: 급변하는 시장에서는 설정 조정 필요

3. **백테스트 권장**: 실제 투자 전 충분한 백테스트 수행

4. **모니터링**: 일일 슬랙 알림 및 로그 확인 필수

## 🔗 관련 모듈

- `executor.py`: 실제 매수/매도 실행
- `selector.py`: AI 기반 종목 선택
- `technical.py`: 기술적 분석 엔진
- `news_sentiment.py`: 뉴스 감정 분석 엔진

## 📊 성과 지표

하이브리드 전략의 기대 효과:
- 기술적 분석만 사용 대비 안정성 향상
- 뉴스 기반 선제적 대응으로 손실 최소화
- 시장 심리 반영으로 수익률 개선

## 🔄 개선 계획 (Improvement Roadmap)

### 1. 거래 비용 반영
- **현재**: 거래 비용 미고려
- **개선**: 증권사 수수료(0.015%) + 세금(0.23%) 반영
- **영향**: 실제 수익률 계산의 정확도 향상

### 2. 시장 상황 적응형 전략
- **현재**: 고정 가중치 (기술적 50% : 뉴스 50%)
- **개선**: 시장 레짐별 동적 가중치 조정
  - 상승장: 기술적 60% : 뉴스 40%
  - 하락장: 기술적 30% : 뉴스 70%
  - 박스권: 기술적 70% : 뉴스 30%
- **구현**: KOSPI/KOSDAQ 지수 분석 기반 시장 상황 판단

### 3. 매매 타이밍 최적화
- **현재**: 고정 시간 (오전 8:30, 오후 3:20)
- **개선**: 
  - VWAP(거래량 가중 평균가) 기반 매매
  - 미국 시장 영향도 반영한 동적 타이밍
  - 분할 매매 시스템 도입
- **기대효과**: 체결가 개선 및 슬리피지 감소

### 4. 종목 선정 고도화
- **현재**: 이동평균선 중심의 기술적 분석
- **개선**:
  - 시가총액/유동성 필터 추가
  - 펀더멘털 지표 통합 (PER, ROE, 부채비율)
  - 섹터별 상대 평가 도입
  - 기관/외국인 수급 분석
- **목표**: 우량주 중심의 안정적 포트폴리오 구성

### 5. 백테스팅 강화
- **현재**: 기본적인 백테스팅 모듈 존재
- **개선**:
  - 최소 3-5년 장기 백테스팅 의무화
  - 다양한 시장 상황별 성과 검증
  - 샤프 비율, 최대 낙폭(MDD) 등 고급 지표 추가
- **활용**: `run_news_backtest.py`, `run_modular_backtest.py` 활용

### 6. 리스크 관리 고도화
- **현재**: 단순 손절선 (-5%)
- **개선**:
  - 변동성 기반 동적 손절선
  - 포트폴리오 상관관계 분석
  - 켈리 공식 기반 포지션 사이징
  - 최대 낙폭 제한 (전체 포트폴리오 -10%)

### 7. 추가 전략 모듈
- **페어 트레이딩**: 상관관계 높은 종목 쌍 활용
- **섹터 로테이션**: 모멘텀 강한 섹터로 자동 이동
- **리스크 패리티**: 종목별 리스크 기여도 균등화

### 8. 기본 품질 필터 (구현 완료 ✅)
- **시가총액 필터**: 2천억원 이상 (균형잡힌 기준)
- **유동성 필터**: 일 거래대금 10억원 이상
- **거래정지/관리종목 제외**: 자동 필터링
- **예상 효과**: 약 200-250개 우량주 중심 종목 풀

## 📅 구현 우선순위

1. **완료 (✅)**
   - 기본 품질 필터 (시가총액, 유동성, 거래정지 제외)
   - 균형잡힌 기준 적용 (시총 2천억, 거래대금 10억)

2. **단기 (1개월 이내)**
   - 거래 비용 반영
   - 백테스팅 검증 강화

3. **중기 (3개월 이내)**
   - 시장 상황 적응형 전략
   - 종목 선정 필터 강화 (펀더멘털 추가)

4. **장기 (6개월 이내)**
   - 매매 타이밍 최적화
   - 추가 전략 모듈 개발

---

*이 문서는 Hanlyang Stock 프로젝트의 strategy.py 모듈에 대한 상세 설명서입니다.*